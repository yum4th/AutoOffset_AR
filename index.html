<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcaea OFFSET判定分析ツール</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        h1 { font-size: 20px; color: #333; }
        .input-group { margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .input-group label { width: 150px; font-weight: bold; }
        /* マイナスを入力しにくくし、見た目を整える */
        input { padding: 8px; width: 100px; font-size: 16px; text-align: right; }
        button { width: 100%; padding: 15px; font-size: 18px; background-color: #0366d6; color: white; border: none; border-radius: 5px; margin-top: 20px; cursor: pointer; }
        button:hover { background-color: #0255b3; }
        .result-box { margin-top: 20px; padding: 15px; background-color: #f6f8fa; border: 1px solid #d1d5da; border-radius: 5px; }
        .result-item { margin: 10px 0; font-size: 18px; }
        .result-value { font-weight: bold; color: #d73a49; }
        .note { font-size: 0.9em; color: #666; margin-top: 20px; }
        .input-alpha { border: 1px solid #0366d6; background-color: #f0f8ff; }
    </style>
</head>
<body>

    <h1>OFFSET / 判定分析</h1>
    <p>各判定の個数を入力して下さい（0以上の整数）</p>
    <p>Pure+はPureからPure Early/Lateを除いた判定のことです</p>

    <div class="input-group">
        <label>Pure+</label>
        <input type="number" id="P" value="0" min="0" step="1">
    </div>
    <div class="input-group">
        <label>Far Late</label>
        <input type="number" id="FL" value="0" min="0" step="1">
    </div>
    <div class="input-group">
        <label>Pure Late</label>
        <input type="number" id="PL" value="0" min="0" step="1">
    </div>
    <div class="input-group">
        <label>Far Early</label>
        <input type="number" id="FE" value="0" min="0" step="1">
    </div>
    <div class="input-group">
        <label>Pure Early</label>
        <input type="number" id="PE" value="0" min="0" step="1">
    </div>

    <hr>
    <div class="input-group">
        <label>有意水準 (&alpha;)<br><span style="font-size:0.8em; font-weight:normal">(例: 0.05 = 95%)</span></label>
        <input type="number" id="alpha" value="0.05" min="0.001" max="0.999" step="0.001" class="input-alpha">
    </div>

    <button onclick="calc()">実行</button>

    <div class="result-box">
        <div class="result-item">LOSTを除いた総ノーツ数 (n): <span id="res-n" class="result-value">-</span></div>
        <div class="result-item">推定された差 (μ): <br><span id="res-mu" class="result-value">-</span> ms</div>
        <div class="result-item"><span id="label-ci">差の95%信頼区間</span>: <br><span id="res-ci" class="result-value">-</span></div>
    </div>

    <div class="note">
        <p>現在設定しているオフセットに推定された差を加えた値をオフセットに設定して下さい</p>
        <p>例えば, 現在のオフセット: 56ms, 推定された差: -3.132msの場合</p>
        <p>56ms + (-3.132) = 52.868 -> 設定するオフセット: 52ms</p>
    </div>
    
    <script>
        // 逆正規累積分布関数の近似（ExcelのNORM.S.INV相当）
        // alphaからZ値を求めるために使用
        function normSInv(p) {
            var a1 = -39.6968302866538, a2 = 220.946098424521, a3 = -275.928510446969;
            var a4 = 138.357751867269, a5 = -30.6647980661472, a6 = 2.50662827745924;
            var b1 = -54.4760987982241, b2 = 161.585836858041, b3 = -155.698979859887;
            var b4 = 66.8013118877197, b5 = -13.2806815528857, c1 = -7.78489400243029e-03;
            var c2 = -3.22396458041136e-01, c3 = -2.40075827716184, c4 = -2.54973253934373;
            var c5 = 4.37466414146497, c6 = 2.93816398269878;
            var d1 = 7.78469570904146e-03, d2 = 3.22467129070039e-01, d3 = 2.445134137143;
            var d4 = 3.75440866190742, p_low = 0.02425, p_high = 1 - p_low;
            var q, r;
            if (0 < p && p < p_low) {
                q = Math.sqrt(-2 * Math.log(p));
                return (((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) /
                    ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            } else if (p_low <= p && p <= p_high) {
                q = p - 0.5;
                r = q * q;
                return (((((a1 * r + a2) * r + a3) * r + a4) * r + a5) * r + a6) * q /
                    (((((b1 * r + b2) * r + b3) * r + b4) * r + b5) * r + 1);
            } else if (p_high < p && p < 1) {
                q = Math.sqrt(-2 * Math.log(1 - p));
                return -(((((c1 * q + c2) * q + c3) * q + c4) * q + c5) * q + c6) /
                    ((((d1 * q + d2) * q + d3) * q + d4) * q + 1);
            }
            // エラーまたは範囲外
            return 0;
        }

        function calc() {
            // 1. 入力を取得
            const P = Number(document.getElementById('P').value);
            const FL = Number(document.getElementById('FL').value);
            const PL = Number(document.getElementById('PL').value);
            const FE = Number(document.getElementById('FE').value);
            const PE = Number(document.getElementById('PE').value);
            
            // Alphaの取得
            const alpha = Number(document.getElementById('alpha').value);

            // 2. エラーチェック：マイナス値
            if (P < 0 || FL < 0 || PL < 0 || FE < 0 || PE < 0) {
                alert("エラー：ノーツ数はマイナスになりません。");
                return;
            }
            
            // Alphaのチェック
            if (alpha <= 0 || alpha >= 1) {
                alert("エラー：alphaは 0 より大きく 1 より小さい値を入力してください。");
                return;
            }

            // 3. 総数 n を計算
            const n = P + FL + PL + FE + PE;

            // エラーチェック：データ不足
            if (n <= 1) {
                alert("データの総数が少なすぎます (2個以上必要です)");
                return;
            }

            // 4. 平均 (mu) の計算
            const mu = (75.0 * (FL - FE) + 37.5 * (PL - PE)) / n;

            // 5. 分散 (sig2) の計算
            const termFE = FE * Math.pow(-75.0 - mu, 2);
            const termPE = PE * Math.pow(-37.5 - mu, 2);
            const termP  = P  * Math.pow(0.0 - mu, 2);
            const termPL = PL * Math.pow(37.5 - mu, 2);
            const termFL = FL * Math.pow(75.0 - mu, 2);

            const sig2 = (termFE + termPE + termP + termPL + termFL) / (n - 1);

            // 6. 信頼区間の計算
            // Z値を計算 (両側検定なので 1 - alpha/2 の点を見る)
            const zScore = normSInv(1 - (alpha / 2));
            
            const margin = zScore * Math.sqrt(sig2 / n);
            const lower = mu - margin;
            const upper = mu + margin;

            // 7. 結果を表示
            document.getElementById('res-n').innerText = n;
            document.getElementById('res-mu').innerText = mu.toFixed(4);
            
            // 表示ラベルの更新 (例: 0.05 -> 95%)
            const percent = Math.round((1 - alpha) * 100);
            document.getElementById('label-ci').innerText = `差の${percent}%信頼区間`;
            
            document.getElementById('res-ci').innerText = `[${lower.toFixed(4)}, ${upper.toFixed(4)}]`;
        }
    </script>

</body>
</html>
